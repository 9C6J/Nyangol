<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëƒ¥ê³¨ ë˜ì „ ìˆ™ì œ ë° ë³´ìƒ íŠ¸ë˜ì»¤</title>
    <!-- ê·€ì—¬ìš´ ìŠ¤íŒŒí´(âœ¨) íŒŒë¹„ì½˜ (Base64 ì¸ì½”ë”©ëœ SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ¨</text></svg>" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Global Constants and Initialization ---
        // Firebase usage is discontinued. Using local storage instead.

        // Local Storage Keys
        const STORAGE_KEY = 'nyangolTrackerData';
        const MEMO_KEY = 'nyangolMemoContent';
        const THEME_KEY = 'nyangolTheme';
        const PRICE_KEY = 'nyangolItemPrices'; // Price storage key
        const LAYOUT_KEY = 'nyangolLayoutV1';
        const MOTION_KEY = 'nyangolMotionEnabled';

        // Reward Rules
        const REWARD_RULES = {
            weekly: { divisor: 10, fragments: 50, feathers: 20 },
            monthly: { divisor: 30, fragments: 100 }
        };
        const DEFAULT_PRICES = { fragmentPrice: 68000, featherPrice: 100000 };
        const THEME_PRESETS = {
            dark: {
                icon: 'ğŸŒ™',
                vars: {
                    '--bg-page': '#0b1220',
                    '--bg-primary': '#1b2538',
                    '--bg-secondary': '#2a3852',
                    '--color-text': '#f8fafc',
                    '--color-text-subtle': '#9fb0c9',
                    '--color-border': '#324664',
                    '--color-accent': '#3b82f6',
                    '--color-reset': '#ef4444',
                    '--color-pin-highlight': '#facc15',
                    '--color-pin-shadow': '250, 204, 21',
                    '--goal-accent-rgb': '250, 204, 21',
                    '--goal-badge-text': '#111827',
                    '--goal-badge-grad-1': '#fde68a',
                    '--goal-badge-grad-2': '#f59e0b',
                    '--goal-badge-grad-3': '#fcd34d',
                    '--coin-color': '#facc15',
                    '--coin-rgb': '250, 204, 21'
                }
            },
            light: {
                icon: 'â˜€ï¸',
                vars: {
                    '--bg-page': '#f4f8ff',
                    '--bg-primary': '#ffffff',
                    '--bg-secondary': '#e8eefc',
                    '--color-text': '#0f172a',
                    '--color-text-subtle': '#55627a',
                    '--color-border': '#c6d3ea',
                    '--color-accent': '#2563eb',
                    '--color-reset': '#dc2626',
                    '--color-pin-highlight': '#1d4ed8',
                    '--color-pin-shadow': '29, 78, 216',
                    '--goal-accent-rgb': '59, 130, 246',
                    '--goal-badge-text': '#ffffff',
                    '--goal-badge-grad-1': '#60a5fa',
                    '--goal-badge-grad-2': '#3b82f6',
                    '--goal-badge-grad-3': '#2563eb',
                    '--coin-color': '#2563eb',
                    '--coin-rgb': '37, 99, 235'
                }
            },
            rose: {
                icon: 'ğŸŒ¸',
                vars: {
                    '--bg-page': '#1a1020',
                    '--bg-primary': '#2a1633',
                    '--bg-secondary': '#3a1f46',
                    '--color-text': '#ffeef8',
                    '--color-text-subtle': '#e4b8d0',
                    '--color-border': '#5c2f72',
                    '--color-accent': '#f472b6',
                    '--color-reset': '#fb7185',
                    '--color-pin-highlight': '#f9a8d4',
                    '--color-pin-shadow': '249, 168, 212',
                    '--goal-accent-rgb': '244, 114, 182',
                    '--goal-badge-text': '#3b0a2b',
                    '--goal-badge-grad-1': '#fbcfe8',
                    '--goal-badge-grad-2': '#f472b6',
                    '--goal-badge-grad-3': '#ec4899',
                    '--coin-color': '#f9a8d4',
                    '--coin-rgb': '249, 168, 212'
                }
            },
            forest: {
                icon: 'ğŸŒ¿',
                vars: {
                    '--bg-page': '#08160f',
                    '--bg-primary': '#10261b',
                    '--bg-secondary': '#1a3a2a',
                    '--color-text': '#ecfdf5',
                    '--color-text-subtle': '#93c5aa',
                    '--color-border': '#2a5a44',
                    '--color-accent': '#22c55e',
                    '--color-reset': '#ef4444',
                    '--color-pin-highlight': '#86efac',
                    '--color-pin-shadow': '134, 239, 172',
                    '--goal-accent-rgb': '34, 197, 94',
                    '--goal-badge-text': '#052e16',
                    '--goal-badge-grad-1': '#bbf7d0',
                    '--goal-badge-grad-2': '#4ade80',
                    '--goal-badge-grad-3': '#22c55e',
                    '--coin-color': '#86efac',
                    '--coin-rgb': '134, 239, 172'
                }
            },
            ocean: {
                icon: 'ğŸŒŠ',
                vars: {
                    '--bg-page': '#071422',
                    '--bg-primary': '#0f2336',
                    '--bg-secondary': '#173248',
                    '--color-text': '#e0f2fe',
                    '--color-text-subtle': '#91bad5',
                    '--color-border': '#28506c',
                    '--color-accent': '#0ea5e9',
                    '--color-reset': '#f43f5e',
                    '--color-pin-highlight': '#67e8f9',
                    '--color-pin-shadow': '103, 232, 249',
                    '--goal-accent-rgb': '14, 165, 233',
                    '--goal-badge-text': '#082f49',
                    '--goal-badge-grad-1': '#bae6fd',
                    '--goal-badge-grad-2': '#38bdf8',
                    '--goal-badge-grad-3': '#0ea5e9',
                    '--coin-color': '#67e8f9',
                    '--coin-rgb': '103, 232, 249'
                }
            }
        };
        const ACTIVE_THEME_KEYS = ['dark', 'ocean', 'light'];
        THEME_PRESETS.dark.icon = 'ğŸŒ™';
        THEME_PRESETS.ocean.icon = 'ğŸŒŠ';
        THEME_PRESETS.light.icon = 'â˜€ï¸';

        // Global State
        let characters = [];
        let itemPrices = DEFAULT_PRICES;
        let currentView = 'tracker';
        let isLayoutEditMode = false;
        let isMotionEnabled = true;

        // Drag and Drop Globals
        let draggedElement = null;
        let draggedSectionElement = null;

        // Repeat/Hold Logic Globals
        let repeatTimer = null;
        let repeatTimeout = null;
        const INITIAL_DELAY = 500;
        const REPEAT_RATE = 100;
        const DRAG_SCROLL_EDGE_PX = 96;
        const DRAG_SCROLL_STEP_PX = 18;

        // Clears the repeating interval and initial timeout
        const stopRepeat = () => {
            clearTimeout(repeatTimeout);
            if (repeatTimer) {
                clearInterval(repeatTimer);
                repeatTimer = null;
            }
        };

        const autoScrollDuringDrag = (clientY) => {
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            if (clientY < DRAG_SCROLL_EDGE_PX) {
                window.scrollBy(0, -DRAG_SCROLL_STEP_PX);
            } else if (clientY > viewportHeight - DRAG_SCROLL_EDGE_PX) {
                window.scrollBy(0, DRAG_SCROLL_STEP_PX);
            }
        };

        // Finds the closest parent card element
        const getCardElement = (target) => {
            return target.closest('.character-card');
        };
        const getLayoutSectionElement = (target) => {
            return target.closest('.layout-section');
        };

        const loadLayoutState = () => {
            const fallback = { trackerOrder: [] };
            const raw = localStorage.getItem(LAYOUT_KEY);
            if (!raw) return fallback;
            try {
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed.trackerOrder)) return fallback;
                return parsed;
            } catch (e) {
                console.error("Error parsing layout data:", e);
                return fallback;
            }
        };

        const saveLayoutState = (trackerOrder) => {
            localStorage.setItem(LAYOUT_KEY, JSON.stringify({ trackerOrder }));
        };

        const applyTrackerLayout = () => {
            const trackerSections = document.getElementById('tracker-sections');
            if (!trackerSections) return;

            const layout = loadLayoutState();
            const sectionMap = {};
            const sections = Array.from(trackerSections.querySelectorAll('.layout-section'));
            sections.forEach((section) => {
                sectionMap[section.dataset.sectionId] = section;
            });

            layout.trackerOrder.forEach((sectionId) => {
                const section = sectionMap[sectionId];
                if (section) trackerSections.appendChild(section);
            });

            sections.forEach((section) => {
                if (!layout.trackerOrder.includes(section.dataset.sectionId)) {
                    trackerSections.appendChild(section);
                }
            });
        };

        const syncTrackerLayoutOrder = () => {
            const trackerSections = document.getElementById('tracker-sections');
            if (!trackerSections) return;
            const order = Array.from(trackerSections.querySelectorAll('.layout-section'))
                .map((section) => section.dataset.sectionId)
                .filter(Boolean);
            saveLayoutState(order);
        };

        const updateLayoutSectionDraggableState = () => {
            const sections = document.querySelectorAll('.layout-section');
            sections.forEach((section) => {
                section.setAttribute('draggable', isLayoutEditMode ? 'true' : 'false');
            });
        };

        const setLayoutEditMode = (enabled) => {
            const wasEnabled = isLayoutEditMode;
            if (wasEnabled && !enabled) {
                syncTrackerLayoutOrder();
            }

            isLayoutEditMode = enabled;
            document.body.classList.toggle('layout-edit-mode', enabled);
            updateLayoutSectionDraggableState();
            renderCharacters();

            const toggleButton = document.getElementById('layout-edit-toggle');
            if (toggleButton) {
                toggleButton.textContent = enabled ? 'ë ˆì´ì•„ì›ƒ ì™„ë£Œ' : 'ë ˆì´ì•„ì›ƒ í¸ì§‘';
            }
        };

        window.toggleLayoutEditMode = () => {
            const nextMode = !isLayoutEditMode;
            setLayoutEditMode(nextMode);
            if (nextMode) {
                showNotification("ì„¹ì…˜ ë“œë˜ê·¸ í¸ì§‘ ëª¨ë“œê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.", 'info');
            } else {
                showNotification("ë ˆì´ì•„ì›ƒ ë³€ê²½ ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
            }
        };

        // --- Local Storage Management (Data) ---

        // Saves data to local storage and updates the UI.
        const saveToLocalStorage = () => {
            reindexCharacters();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(characters));
            if (currentView === 'tracker') {
                renderCharacters();
            } else {
                renderSettlement(); // Re-render settlement view if active
            }
        };

        // Loads data from local storage on browser load.
        const loadFromLocalStorage = () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    characters = JSON.parse(storedData);
                    // Initialize missing fields for compatibility
                    characters.forEach((char, index) => {
                        if (typeof char.weeklyCount === 'undefined') char.weeklyCount = 0;
                        if (typeof char.monthlyCount === 'undefined') char.monthlyCount = 0;
                        if (typeof char.isCompleted === 'undefined') char.isCompleted = false;
                        if (typeof char.isPinned === 'undefined') char.isPinned = false;
                        if (typeof char.orderIndex === 'undefined' || char.orderIndex === null) {
                            char.orderIndex = index;
                        }
                        if (typeof char.lastUpdated === 'undefined') {
                            char.lastUpdated = Date.now();
                        }
                    });
                    reindexCharacters();
                } catch (e) {
                    console.error("Error parsing local storage data:", e);
                    characters = [];
                }
            }

            // Memo load and UI reflection
            const storedMemo = localStorage.getItem(MEMO_KEY);
            const memoInput = document.getElementById('memo-input');
            if (storedMemo && memoInput) {
                memoInput.value = storedMemo;
            }

            // Update user info area
            document.getElementById('user-info').textContent = 'ë°ì´í„°ëŠ” ì´ ì›¹ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.';
            renderCharacters(); // Initial render for tracker view
            loadPrices(); // Load item prices
        };

        // Function to re-assign continuous orderIndex to all characters
        const reindexCharacters = () => {
            // 1. First, sort by the desired visual order (pinned, then current orderIndex)
            characters.sort((a, b) => {
                const pinSort = (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0);
                if (pinSort !== 0) {
                    return pinSort;
                }
                // Secondary sort: by custom order index
                return (a.orderIndex || 0) - (b.orderIndex || 0);
            });

            // 2. Then, re-assign a new sequential index
            characters.forEach((char, index) => {
                char.orderIndex = index;
            });
        };

        // --- Local Storage Management (Prices) ---

        const loadPrices = () => {
            const storedPrices = localStorage.getItem(PRICE_KEY);
            if (storedPrices) {
                try {
                    itemPrices = { ...DEFAULT_PRICES, ...JSON.parse(storedPrices) };
                } catch (e) {
                    console.error("Error parsing price data:", e);
                    itemPrices = DEFAULT_PRICES;
                }
            }
        };

        const savePrices = () => {
            localStorage.setItem(PRICE_KEY, JSON.stringify(itemPrices));
            // Only re-render settlement if we are in that view
            if (currentView === 'settlement') {
                renderSettlement();
            }
        };


        // --- Theme Management ---
        const applyThemeLegacy = (theme) => {
            const body = document.body;
            const toggleButton = document.getElementById('theme-icon');

            if (theme === 'light') {
                body.classList.add('light-theme');
                if (toggleButton) {
                    toggleButton.innerHTML = 'ğŸŒ™'; // Dark mode icon
                    toggleButton.title = 'ë‹¤í¬ ëª¨ë“œë¡œ ì „í™˜';
                }
            } else { // dark
                body.classList.remove('light-theme');
                if (toggleButton) {
                    toggleButton.innerHTML = 'â˜€ï¸'; // Light mode icon
                    toggleButton.title = 'ë¼ì´íŠ¸ ëª¨ë“œë¡œ ì „í™˜';
                }
            }
            localStorage.setItem(THEME_KEY, theme);
        };

        window.toggleThemeLegacy = () => { // legacy
            const currentTheme = localStorage.getItem(THEME_KEY) === 'light' ? 'dark' : 'light';
            applyTheme(currentTheme);
        };

        const loadThemeLegacy = () => {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark'; // Default to dark
            applyTheme(savedTheme);
        };

        const applyTheme = (theme) => {
            const body = document.body;
            const root = document.documentElement;
            const toggleButton = document.getElementById('theme-icon');
            const normalizedTheme = ACTIVE_THEME_KEYS.includes(theme) ? theme : 'dark';
            const preset = THEME_PRESETS[normalizedTheme] || THEME_PRESETS.dark;
            Object.entries(preset.vars).forEach(([name, value]) => {
                root.style.setProperty(name, value);
            });
            if (normalizedTheme === 'light') {
                root.style.setProperty('--bg-page', '#f5f7fb');
                root.style.setProperty('--bg-secondary', '#e2e8f5');
                root.style.setProperty('--color-text', '#0b1324');
                root.style.setProperty('--color-text-subtle', '#334155');
                root.style.setProperty('--color-border', '#94a3b8');
                root.style.setProperty('--color-accent', '#1d4ed8');
                root.style.setProperty('--coin-color', '#1d4ed8');
                root.style.setProperty('--coin-rgb', '29, 78, 216');
            }
            body.dataset.theme = normalizedTheme;
            if (toggleButton) toggleButton.textContent = preset.icon;
            localStorage.setItem(THEME_KEY, normalizedTheme);
        };

        window.toggleTheme = () => {
            const currentTheme = localStorage.getItem(THEME_KEY) || 'dark';
            const currentIndex = ACTIVE_THEME_KEYS.indexOf(currentTheme);
            const safeIndex = currentIndex === -1 ? 0 : currentIndex;
            const nextTheme = ACTIVE_THEME_KEYS[(safeIndex + 1) % ACTIVE_THEME_KEYS.length];
            applyTheme(nextTheme);
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
            applyTheme(ACTIVE_THEME_KEYS.includes(savedTheme) ? savedTheme : 'dark');
        };

        const applyMotionPreference = (enabled) => {
            isMotionEnabled = enabled;
            document.body.dataset.motion = enabled ? 'on' : 'off';
            localStorage.setItem(MOTION_KEY, enabled ? 'true' : 'false');

            const toggleButton = document.getElementById('motion-toggle');
            if (toggleButton) {
                toggleButton.textContent = enabled ? 'Animation ON' : 'Animation OFF';
                toggleButton.title = enabled ? 'Turn animation off' : 'Turn animation on';
            }
        };

        window.toggleMotionEffects = () => {
            applyMotionPreference(!isMotionEnabled);
        };

        const loadMotionPreference = () => {
            const saved = localStorage.getItem(MOTION_KEY);
            if (saved === null) {
                const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                applyMotionPreference(!prefersReduced);
                return;
            }
            applyMotionPreference(saved === 'true');
        };

        // --- View Switching ---

        window.switchView = (viewId) => {
            const trackerView = document.getElementById('tracker-view');
            const settlementView = document.getElementById('settlement-view');
            const toggleButton = document.getElementById('view-toggle-button');
            const layoutEditButton = document.getElementById('layout-edit-toggle');

            currentView = viewId;

            if (viewId === 'settlement') {
                if (isLayoutEditMode) setLayoutEditMode(false);
                trackerView.classList.add('hidden');
                settlementView.classList.remove('hidden');
                if (layoutEditButton && layoutEditButton.parentElement) {
                    layoutEditButton.parentElement.classList.add('hidden');
                }
                toggleButton.textContent = 'ğŸ  íŠ¸ë˜ì»¤ ëŒì•„ê°€ê¸°';
                toggleButton.onclick = () => switchView('tracker');
                renderSettlement(); // Render the content immediately
            } else { // 'tracker'
                trackerView.classList.remove('hidden');
                settlementView.classList.add('hidden');
                if (layoutEditButton && layoutEditButton.parentElement) {
                    layoutEditButton.parentElement.classList.remove('hidden');
                }
                toggleButton.textContent = 'ğŸ’° ì •ì‚°í‘œ ë³´ê¸°';
                toggleButton.onclick = () => switchView('settlement');
                renderCharacters(); // Re-render the tracker list
            }
        };


        // --- UI Rendering Functions (Tracker View) ---

        const renderCharacters = () => {
            const characterListDiv = document.getElementById('character-list');
            // Check if the element exists and the current view is tracker before rendering
            if (!characterListDiv || currentView !== 'tracker') return;

            characterListDiv.innerHTML = ''; // Clear existing list

            if (characters.length === 0) {
                characterListDiv.innerHTML = '<p class="text-subtle-theme p-4 text-center">ì•„ì§ ë“±ë¡ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ìºë¦­í„°ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p>';
                return;
            }

            // Sort (Done in reindexCharacters/saveToLocalStorage, but re-sorting here for clarity)
            characters.sort((a, b) => {
                const pinSort = (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0);
                if (pinSort !== 0) {
                    return pinSort;
                }
                return (a.orderIndex || 0) - (b.orderIndex || 0);
            });

            // Create cards for each character
            characters.forEach((charData,idx) => {
                characterListDiv.appendChild(createCharacterCard(charData,idx));
            });
        };

        const createCharacterCard = (data,idx) => {
            const charId = data.id;
            const isWeeklyGoalReached = data.weeklyCount >= REWARD_RULES.weekly.divisor;
            const isMonthlyGoalReached = data.monthlyCount >= REWARD_RULES.monthly.divisor;
            const isGoalReached = isWeeklyGoalReached || isMonthlyGoalReached;

            const card = document.createElement('div');
            const pinBorderClass = data.isPinned ? 'border-pin-highlight shadow-lg' : 'hover:border-accent-blue';
            const cardCursorClass = isLayoutEditMode ? 'cursor-default' : 'cursor-grab active:cursor-grabbing';
            const goalCardClass = isGoalReached ? 'goal-achieved-card' : '';
            card.className = `character-card bg-secondary-theme p-4 rounded-xl shadow-lg flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0 sm:space-x-4 border border-theme transition duration-200 ${cardCursorClass} ${data.isCompleted ? 'opacity-70 border-green-500/50' : pinBorderClass} ${goalCardClass}`;
            card.dataset.id = charId;

            // Drag character cards only in normal mode.
            if (!isLayoutEditMode) {
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            } else {
                card.setAttribute('draggable', 'false');
            }

            // 1. Name, Completion Checkbox, Pin, and ID
            const nameSection = document.createElement('div');
            nameSection.className = 'flex flex-col items-center sm:items-start w-full sm:w-[25%] min-w-[150px]';

            // Check weekly count for visual highlight (FEATURE 1)
            const isWeeklyOver5 = data.weeklyCount >= 5;
            const weeklyHighlightClass = isWeeklyGoalReached
                ? 'text-amber-300 font-extrabold goal-counter'
                : (isWeeklyOver5 ? 'text-red-500 font-extrabold' : 'text-accent-blue');
            const monthlyHighlightClass = isMonthlyGoalReached
                ? 'text-amber-300 font-extrabold goal-counter'
                : 'text-accent-blue';

            const nameControls = document.createElement('div');
            nameControls.className = 'flex items-center space-x-2';

            // Checkbox (DESIGN IMPROVEMENT APPLIED)
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            // Bolder, slightly larger, and more rounded checkbox style
            // Note: Relying on browser default checkmark and Tailwind's ability to style the box.
            checkbox.className = 'h-6 w-6 text-green-500 bg-secondary-theme border-2 border-theme rounded-lg focus:ring-green-500 cursor-pointer flex-shrink-0';
            checkbox.checked = data.isCompleted;
            checkbox.title = 'ìˆ™ì œ ì™„ë£Œ ì²´í¬';
            checkbox.onchange = () => toggleCompletion(charId);

            // Pin Button
            const pinButton = document.createElement('button');
            const pinIcon = data.isPinned ? 'ğŸ“Œ' : 'ğŸ“';
            const pinColorClass = data.isPinned ? 'text-pin-highlight' : 'text-subtle-theme hover:text-pin-highlight';
            pinButton.className = `p-1 rounded-full text-lg transition duration-150 ${pinColorClass}`;
            pinButton.innerHTML = pinIcon;
            pinButton.title = data.isPinned ? 'ê³ ì • í•´ì œ' : 'ìƒë‹¨ ê³ ì •';
            pinButton.onclick = (e) => {
                e.stopPropagation();
                togglePin(charId);
            };

            const nameEl = document.createElement('p');
            const nameTextColor = data.isPinned ? 'text-pin-highlight' : '';
            // FEATURE 2 REVERTED: Removed clickable classes and handler.
            nameEl.className = `text-xl font-bold ${data.isCompleted ? 'line-through text-subtle-theme' : nameTextColor}`;
            nameEl.textContent = data.name;

            // Name click handler removed (was previously nameEl.onclick)

            const idSpan = document.createElement('span');
            idSpan.className = 'text-xs text-subtle-theme mt-1';
            idSpan.textContent = `ìˆœë²ˆ: ${idx+1}`;

            nameControls.appendChild(checkbox);
            nameControls.appendChild(pinButton);
            nameControls.appendChild(nameEl);

            nameSection.appendChild(nameControls);
            nameSection.appendChild(idSpan);

            // 2. Weekly Count Section (FEATURE 1 usage)
            const weeklySection = createCounterSection(
                'ì£¼ê°„ ëƒ¥ê³¨',
                data.weeklyCount,
                'weeklyCount',
                charId,
                weeklyHighlightClass // Pass highlight class
            );

            // 3. Monthly Count Section (Uses default accent color)
            const monthlySection = createCounterSection(
                'ì›”ê°„ ëƒ¥ê³¨',
                data.monthlyCount,
                'monthlyCount',
                charId,
                monthlyHighlightClass
            );

            // 4. Delete Button
            const deleteButton = document.createElement('button');
            deleteButton.className = 'text-accent-red hover:opacity-80 p-2 rounded-full transition duration-150 flex-shrink-0';
            deleteButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            `;
            deleteButton.title = `${data.name} ìºë¦­í„° ì‚­ì œ`;
            deleteButton.onclick = () => deleteCharacter(charId, data.name);

            // Combine all sections
            card.appendChild(nameSection);
            card.appendChild(weeklySection);
            card.appendChild(monthlySection);
            card.appendChild(deleteButton);
            if (isGoalReached) {
                let goalLabel = 'ì£¼ê°„ ì™„ë£Œ';
                let effectMode = 'weekly';
                let effectRows = 1;
                const monthlyTierRows = Math.min(3, Math.max(0, Math.floor(data.monthlyCount / 10)));
                if (isWeeklyGoalReached && isMonthlyGoalReached) {
                    goalLabel = 'ì£¼ê°„/ì›”ê°„ ì™„ë£Œ';
                    effectMode = 'monthly';
                    effectRows = Math.max(1, monthlyTierRows);
                } else if (isMonthlyGoalReached) {
                    goalLabel = 'ì›”ê°„ ì™„ë£Œ';
                    effectMode = 'monthly';
                    effectRows = Math.max(1, monthlyTierRows);
                } else if (isWeeklyGoalReached && monthlyTierRows > 0) {
                    effectMode = 'monthly';
                    effectRows = monthlyTierRows;
                }
                card.appendChild(createGoalCelebrationLayer(goalLabel, effectMode, effectRows));
            }

            return card;
        };

        const createGoalCelebrationLayer = (label, mode = 'weekly', rowCount = 1) => {
            const layer = document.createElement('div');
            layer.className = 'goal-celebration';
            layer.dataset.mode = mode;

            const createEffect = (className, style = {}, text = '') => {
                const node = document.createElement('span');
                node.className = className;
                Object.entries(style).forEach(([key, value]) => node.style.setProperty(key, value));
                if (text) node.textContent = text;
                return node;
            };

            const normalizedRows = Math.min(3, Math.max(1, Number(rowCount) || 1));
            const rowOffsets = mode === 'monthly'
                ? Array.from({ length: normalizedRows }, (_, idx) => idx * 20)
                : [0];
            rowOffsets.forEach((rowY, rowIndex) => {
                [-48, -24, 0, 24, 48].forEach((offset, coinIndex) => {
                    layer.appendChild(
                        createEffect(
                            'fx-money-coin',
                            {
                                '--offset-x': `${offset}px`,
                                '--row-y': `${rowY}px`,
                                '--delay': `${(coinIndex * 0.08) + (rowIndex * 0.14)}s`
                            },
                            'â‚©'
                        )
                    );
                });
            });

            const badge = document.createElement('span');
            badge.className = 'goal-badge';
            badge.textContent = label;
            layer.appendChild(badge);

            return layer;
        };

        // Updated function signature to accept highlightClass
        const createCounterSection = (title, count, fieldName, charId, highlightClass) => {
            const section = document.createElement('div');
            section.className = 'counter-section flex flex-col items-center w-full sm:w-[30%] min-w-[120px]';

            // Title
            const titleEl = document.createElement('p');
            titleEl.className = 'text-sm font-medium text-subtle-theme mb-1 mr-[45px]';
            titleEl.textContent = title;

            // Count Display and Controls
            const controls = document.createElement('div');
            controls.className = 'flex items-center space-x-1.5';

            const countEl = document.createElement('span');
            // Use the passed highlightClass directly here (FEATURE 1)
            countEl.className = `text-3xl font-extrabold w-12 text-center ${highlightClass}`;
            countEl.textContent = String(count).padStart(2, '0');

            // Decrement Button
            const decrementBtn = document.createElement('button');
            decrementBtn.className = 'w-10 h-10 bg-gray-600 text-white rounded-full text-2xl font-bold transition hover:opacity-80 shadow-md';
            decrementBtn.textContent = '-';
            decrementBtn.title = 'ì¹´ìš´íŠ¸ 1 ê°ì†Œ (ê¸¸ê²Œ ëˆ„ë¥´ë©´ ë°˜ë³µ)';
            setupCounterEvents(decrementBtn, charId, fieldName, 'decrement');

            // Increment Button
            const incrementBtn = document.createElement('button');
            incrementBtn.className = 'w-10 h-10 bg-accent-blue text-white rounded-full text-2xl font-bold transition hover:opacity-80 shadow-md';
            incrementBtn.textContent = '+';
            incrementBtn.title = 'ì¹´ìš´íŠ¸ 1 ì¦ê°€ (ê¸¸ê²Œ ëˆ„ë¥´ë©´ ë°˜ë³µ)';
            setupCounterEvents(incrementBtn, charId, fieldName, 'increment');

            // Individual Reset Button
            const resetIndividualBtn = document.createElement('button');
            const resetIcon = fieldName === 'weeklyCount' ? '&#8635;' : '&#128197;';
            resetIndividualBtn.className = 'w-10 h-10 bg-gray-700 text-white rounded-full text-xl font-bold transition hover:opacity-80 shadow-md border border-transparent hover:border-theme';
            resetIndividualBtn.innerHTML = resetIcon;
            resetIndividualBtn.title = `${title} ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”`;
            resetIndividualBtn.setAttribute('aria-label', `${title} ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”`);
            resetIndividualBtn.onclick = () => handleCountAction(charId, fieldName, 'reset');


            controls.appendChild(decrementBtn);
            controls.appendChild(countEl);
            controls.appendChild(incrementBtn);
            controls.appendChild(resetIndividualBtn);

            section.appendChild(titleEl);
            section.appendChild(controls);

            return section;
        };


        // --- Reward Calculation Logic (Settlement View) ---

        const calculateRewards = () => {
            let totalFragments = 0;
            let totalFeathers = 0;
            const rewardPerCharacter = [];

            characters.forEach(char => {
                // Calculate batches for weekly rewards (10 per batch)
                const weeklyBatches = Math.floor(char.weeklyCount / REWARD_RULES.weekly.divisor);
                totalFragments += weeklyBatches * REWARD_RULES.weekly.fragments;
                totalFeathers += weeklyBatches * REWARD_RULES.weekly.feathers;

                // Calculate batches for monthly rewards (30 per batch)
                const monthlyBatches = Math.floor(char.monthlyCount / REWARD_RULES.monthly.divisor);
                totalFragments += monthlyBatches * REWARD_RULES.monthly.fragments;

                rewardPerCharacter.push({
                    name: char.name,
                    weeklyBatches: weeklyBatches,
                    monthlyBatches: monthlyBatches,
                    fragments: (weeklyBatches * REWARD_RULES.weekly.fragments) + (monthlyBatches * REWARD_RULES.monthly.fragments),
                    feathers: weeklyBatches * REWARD_RULES.weekly.feathers
                });
            });

            // Calculate total gold value
            const totalGold = (totalFragments * itemPrices.fragmentPrice) + (totalFeathers * itemPrices.featherPrice);

            return {
                totalFragments,
                totalFeathers,
                totalGold,
                rewardPerCharacter
            };
        };

        // --- UI Rendering Functions (Settlement View) ---

        const formatNumber = (num) => {
            // Use Intl.NumberFormat for locale-specific formatting (Korean convention for large numbers)
            return new Intl.NumberFormat('ko-KR').format(num);
        };

        const renderSettlement = () => {
            const settlementContainer = document.getElementById('settlement-content');
            if (!settlementContainer || currentView !== 'settlement') return;

            const rewards = calculateRewards();

            settlementContainer.innerHTML = `
                <div class="space-y-8">

                    <!-- 1. Price Input Section -->
                    <div class="bg-primary-theme p-6 rounded-xl shadow-inner border border-theme">
                        <h3 class="text-xl font-bold mb-4 text-accent-blue">ğŸ’° ì•„ì´í…œ í˜„ì¬ ê°€ê²© ì…ë ¥</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- ë´‰í˜íŒŒ ê°€ê²© -->
                            <div class="flex flex-col">
                                <label for="fragment-price" class="text-subtle-theme text-sm font-medium mb-1">ë´‰ì¸ëœ í˜ì˜ íŒŒí¸ (ë´‰í˜íŒŒ) ê°œë‹¹ ê°€ê²© (ê³¨ë“œ)</label>
                                <input type="number" id="fragment-price"
                                    value="${itemPrices.fragmentPrice}" min="0" step="1000"
                                    placeholder="ë´‰í˜íŒŒ ê°œë‹¹ ê°€ê²©"
                                    class="theme-input p-3 rounded-lg focus:ring-accent-blue focus:border-accent-blue outline-none text-xl font-bold"
                                    oninput="handlePriceChange('fragmentPrice', this.value)">
                            </div>
                            <!-- ê³ ê°•ë¹„ ê°€ê²© -->
                            <div class="flex flex-col">
                                <label for="feather-price" class="text-subtle-theme text-sm font-medium mb-1">ê³ ê¸‰ ê°•í™”ì˜ ë¹„ì•½ (ê³ ê°•ë¹„) ê°œë‹¹ ê°€ê²© (ê³¨ë“œ)</label>
                                <input type="number" id="feather-price"
                                    value="${itemPrices.featherPrice}" min="0" step="1000"
                                    placeholder="ê³ ê°•ë¹„ ê°œë‹¹ ê°€ê²©"
                                    class="theme-input p-3 rounded-lg focus:ring-accent-blue focus:border-accent-blue outline-none text-xl font-bold"
                                    oninput="handlePriceChange('featherPrice', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- 2. Total Reward Summary -->
                    <div class="bg-secondary-theme p-6 rounded-xl shadow-lg border border-theme">
                        <h3 class="text-2xl font-bold mb-4">ğŸ† ì „ì²´ ì •ì‚° ê²°ê³¼</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">

                            <!-- ì´ ë´‰í˜íŒŒ -->
                            <div class="p-4 bg-primary-theme rounded-lg border border-theme">
                                <p class="text-subtle-theme text-sm">ì´ ë´‰í˜íŒŒ ìˆ˜ëŸ‰</p>
                                <p class="text-3xl font-extrabold text-pin-highlight">${formatNumber(rewards.totalFragments)}ê°œ</p>
                            </div>

                            <!-- ì´ ê³ ê°•ë¹„ -->
                            <div class="p-4 bg-primary-theme rounded-lg border border-theme">
                                <p class="text-subtle-theme text-sm">ì´ ê³ ê°•ë¹„ ìˆ˜ëŸ‰</p>
                                <p class="text-3xl font-extrabold text-pin-highlight">${formatNumber(rewards.totalFeathers)}ê°œ</p>
                            </div>

                            <!-- ì´ ê³¨ë“œ ê°€ì¹˜ -->
                            <div class="p-4 bg-primary-theme rounded-lg border border-theme col-span-1 sm:col-span-1">
                                <p class="text-subtle-theme text-sm">ì´ ì˜ˆìƒ ê³¨ë“œ ê°€ì¹˜</p>
                                <p class="text-3xl font-extrabold text-green-500">${formatNumber(rewards.totalGold)}G</p>
                            </div>
                        </div>
                        <p class="text-xs text-subtle-theme mt-4">* ì´ ê¸ˆì•¡ì€ ì…ë ¥ëœ ì•„ì´í…œ ê°€ê²©ì— ê¸°ë°˜í•œ ì˜ˆìƒì¹˜ì…ë‹ˆë‹¤.</p>
                    </div>

                    <!-- 3. Character Breakdown Table -->
                    <div class="bg-primary-theme p-6 rounded-xl shadow-lg border border-theme">
                        <h3 class="text-2xl font-bold mb-4">ìºë¦­í„°ë³„ ìƒì„¸ ì •ì‚°</h3>

                        ${rewards.rewardPerCharacter.length > 0 ? `
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-theme">
                                <thead class="bg-secondary-theme">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-subtle-theme uppercase tracking-wider rounded-tl-lg">ìºë¦­í„° ì´ë¦„</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-subtle-theme uppercase tracking-wider">ì£¼ê°„ ì •ì‚° íšŸìˆ˜</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-subtle-theme uppercase tracking-wider">ì›”ê°„ ì •ì‚° íšŸìˆ˜</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-subtle-theme uppercase tracking-wider">ë´‰í˜íŒŒ ì´ëŸ‰</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-subtle-theme uppercase tracking-wider rounded-tr-lg">ê³ ê°•ë¹„ ì´ëŸ‰</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-theme">
                                    ${rewards.rewardPerCharacter.map(char => `
                                        <tr class="hover:bg-secondary-theme transition duration-150">
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">${char.name}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center">${char.weeklyBatches}íšŒ</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center">${char.monthlyBatches}íšŒ</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-semibold text-pin-highlight">${formatNumber(char.fragments)}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-semibold text-pin-highlight">${formatNumber(char.feathers)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : `<p class="text-subtle-theme text-center p-4">ë“±ë¡ëœ ìºë¦­í„°ê°€ ì—†ì–´ ì •ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`}

                        <p class="text-sm text-subtle-theme mt-4">
                            ì •ì‚° ê¸°ì¤€: ì£¼ê°„ 10íšŒ = ë´‰í˜íŒŒ 50 + ê³ ê°•ë¹„ 20 / ì›”ê°„ 30íšŒ = ë´‰í˜íŒŒ 100
                        </p>
                    </div>
                </div>
            `;
        };

        // NEW: Handler for price input changes
        window.handlePriceChange = (key, value) => {
            const numValue = parseInt(value, 10);
            itemPrices[key] = isNaN(numValue) || numValue < 0 ? 0 : numValue;
            savePrices(); // Save the new price and re-render settlement view
        };

        // --- Data Manipulation Functions ---
        const addCharacter = (name) => {
            const newId = Date.now();
            const newCharacter = {
                id: newId,
                name: name,
                weeklyCount: 0,
                monthlyCount: 0,
                isCompleted: false,
                isPinned: false,
                lastUpdated: newId,
                orderIndex: characters.length
            };
            characters.push(newCharacter);
            saveToLocalStorage(); // Save and render
        };

        const toggleCompletion = (charId) => {
            const charIndex = characters.findIndex(char => char.id === charId);
            if (charIndex === -1) {
                showNotification("ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            characters[charIndex].isCompleted = !characters[charIndex].isCompleted;
            saveToLocalStorage();
        };

        // Toggle Pin Function
        const togglePin = (charId) => {
            const charIndex = characters.findIndex(char => char.id === charId);
            if (charIndex === -1) {
                showNotification("ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const isPinning = !characters[charIndex].isPinned;
            characters[charIndex].isPinned = isPinning;
            reindexCharacters();

            saveToLocalStorage();
            showNotification(isPinning ? `'${characters[charIndex].name}'ì„(ë¥¼) ìƒë‹¨ì— ê³ ì •í–ˆìŠµë‹ˆë‹¤.` : `'${characters[charIndex].name}' ê³ ì •ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.`, 'info');
        };

        const handleCountAction = (charId, fieldName, action) => {
            const charIndex = characters.findIndex(char => char.id === charId);
            if (charIndex === -1) {
                console.error("Character not found for ID:", charId);
                return;
            }

            const data = characters[charIndex];
            const MONTHLY_CAP = REWARD_RULES.monthly.divisor;
            const previousWeeklyCount = data.weeklyCount;
            const previousMonthlyCount = data.monthlyCount;
            let updated = false;

            if (fieldName === 'weeklyCount') {
                if (action === 'increment') {
                    data.weeklyCount += 1;
                    updated = true;

                    if (data.monthlyCount < MONTHLY_CAP) {
                        data.monthlyCount = Math.min(data.monthlyCount + 1, MONTHLY_CAP);
                    } else if (data.monthlyCount === MONTHLY_CAP && data.weeklyCount === 1) {
                        showNotification(`ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ ìµœëŒ€ì¹˜(${MONTHLY_CAP})ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.`, 'info');
                    }
                } else if (action === 'decrement') {
                    if (data.weeklyCount > 0) {
                        data.weeklyCount -= 1;
                        updated = true;

                        if (data.monthlyCount > 0) {
                            data.monthlyCount -= 1;
                        }
                    }
                } else if (action === 'reset') {
                    if (data.weeklyCount !== 0) {
                        data.weeklyCount = 0;
                        updated = true;
                    }
                }
            } else if (fieldName === 'monthlyCount') {
                if (action === 'increment') {
                    const newMonthlyCount = Math.min(data.monthlyCount + 1, MONTHLY_CAP);

                    if (newMonthlyCount !== data.monthlyCount) {
                        data.monthlyCount = newMonthlyCount;
                        updated = true;

                        if (newMonthlyCount === MONTHLY_CAP) {
                            showNotification(`ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ ìµœëŒ€ì¹˜(${MONTHLY_CAP})ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.`, 'info');
                        }
                    }
                } else if (action === 'decrement') {
                    if (data.monthlyCount > 0) {
                        data.monthlyCount -= 1;
                        updated = true;
                    }
                } else if (action === 'reset') {
                    if (data.monthlyCount !== 0) {
                        data.monthlyCount = 0;
                        updated = true;
                    }
                }
            }

            if (updated) {
                if (previousWeeklyCount < REWARD_RULES.weekly.divisor && data.weeklyCount >= REWARD_RULES.weekly.divisor) {
                    showNotification(`${data.name} ì£¼ê°„ ëƒ¥ê³¨ ìˆ™ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                }
                if (previousMonthlyCount < REWARD_RULES.monthly.divisor && data.monthlyCount >= REWARD_RULES.monthly.divisor) {
                    const monthlyDoneMessage = data.weeklyCount >= REWARD_RULES.weekly.divisor
                        ? `${data.name} ì£¼ê°„/ì›”ê°„ ëƒ¥ê³¨ ìˆ™ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`
                        : `${data.name} ì›”ê°„ ëƒ¥ê³¨ ìˆ™ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;
                    showNotification(monthlyDoneMessage, 'success');
                }
                saveToLocalStorage();
            }
        };

        const deleteCharacter = async (charId, charName) => {
            const confirmed = await window.confirm(`ì •ë§ë¡œ ìºë¦­í„° '${charName}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmed) {
                return;
            }

            const initialLength = characters.length;
            characters = characters.filter(char => char.id !== charId);

            if (characters.length < initialLength) {
                saveToLocalStorage(); // Reindexes and saves
                showNotification(`ìºë¦­í„° '${charName}'ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                showNotification("ìºë¦­í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'error');
            }
        };

        // Resets weekly/monthly counts for all characters by target type.
        const resetCountsByType = async (type = 'all') => {
            const messages = {
                all: {
                    confirm: "ê²½ê³ : ëª¨ë“  ìºë¦­í„°ì˜ ì£¼ê°„/ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    done: "ëª¨ë“  ìºë¦­í„°ì˜ ì£¼ê°„/ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
                },
                weekly: {
                    confirm: "ê²½ê³ : ëª¨ë“  ìºë¦­í„°ì˜ ì£¼ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    done: "ëª¨ë“  ìºë¦­í„°ì˜ ì£¼ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
                },
                monthly: {
                    confirm: "ê²½ê³ : ëª¨ë“  ìºë¦­í„°ì˜ ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                    done: "ëª¨ë“  ìºë¦­í„°ì˜ ì›”ê°„ ëƒ¥ê³¨ ì¹´ìš´íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
                }
            };
            const targetType = Object.prototype.hasOwnProperty.call(messages, type) ? type : 'all';

            const confirmed = await window.confirm(messages[targetType].confirm);
            if (!confirmed) return;

            if (characters.length === 0) {
                showNotification("ì´ˆê¸°í™”í•  ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", 'info');
                return;
            }

            characters = characters.map((char) => ({
                ...char,
                weeklyCount: targetType === 'monthly' ? char.weeklyCount : 0,
                monthlyCount: targetType === 'weekly' ? char.monthlyCount : 0,
            }));

            saveToLocalStorage();
            showNotification(messages[targetType].done, 'success');
        };

        const resetAllData = async () => resetCountsByType('all');
        const resetWeeklyData = async () => resetCountsByType('weekly');
        const resetMonthlyData = async () => resetCountsByType('monthly');

        // --- Drag and Drop Handlers ---

        const handleDragStart = (e) => {
            if (isLayoutEditMode) return;
            const card = getCardElement(e.target);
            if (!card) return;

            draggedElement = card;
            e.dataTransfer.setData('text/plain', card.dataset.id);

            setTimeout(() => {
                card.classList.add('opacity-40', 'drag-shadow');
            }, 0);
        };

        const handleDragOver = (e) => {
            if (isLayoutEditMode) return;
            e.preventDefault();
            const targetCard = getCardElement(e.target);
            if (!targetCard || targetCard === draggedElement) return;

            const characterList = document.getElementById('character-list');
            const boundingBox = targetCard.getBoundingClientRect();
            const offset = boundingBox.y + (boundingBox.height / 2);

            if (e.clientY < offset) {
                characterList.insertBefore(draggedElement, targetCard);
            } else {
                characterList.insertBefore(draggedElement, targetCard.nextSibling);
            }
        };

        const handleDragEnd = (e) => {
            const card = getCardElement(e.target);
            if (card) {
                card.classList.remove('opacity-40', 'drag-shadow');
            }
            draggedElement = null;
        };

        const handleDrop = (e) => {
            if (isLayoutEditMode) return;
            e.preventDefault();
            if (!draggedElement) return;

            // 1. Get the final DOM order
            const listChildren = Array.from(document.getElementById('character-list').children);
            const newOrderIds = listChildren.map(child => Number(child.dataset.id));

            // 2. Map the new DOM order back to the characters array and reassign orderIndex
            const characterMap = characters.reduce((map, char) => {
                map[char.id] = char;
                return map;
            }, {});

            let newCharacters = [];
            newOrderIds.forEach((id, index) => {
                const char = characterMap[id];
                if (char) {
                    char.orderIndex = index;
                    newCharacters.push(char);
                }
            });

            // 3. Replace the global array and save
            characters = newCharacters;
            saveToLocalStorage();

            showNotification("ìºë¦­í„° ìˆœì„œê°€ ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
        };
        // --- End Drag and Drop Handlers ---

        // --- Layout Section Drag and Drop Handlers ---
        const handleSectionDragStart = (e) => {
            if (!isLayoutEditMode) return;
            const section = getLayoutSectionElement(e.target);
            if (!section) return;
            draggedSectionElement = section;
            e.dataTransfer.setData('text/plain', section.dataset.sectionId || '');
            setTimeout(() => {
                section.classList.add('dragging-section');
            }, 0);
        };

        const handleSectionDragOver = (e) => {
            if (!isLayoutEditMode) return;
            e.preventDefault();
            autoScrollDuringDrag(e.clientY);
            const targetSection = getLayoutSectionElement(e.target);
            if (!targetSection || targetSection === draggedSectionElement) return;

            const trackerSections = document.getElementById('tracker-sections');
            if (!trackerSections) return;

            const boundingBox = targetSection.getBoundingClientRect();
            const offset = boundingBox.y + (boundingBox.height / 2);
            if (e.clientY < offset) {
                trackerSections.insertBefore(draggedSectionElement, targetSection);
            } else {
                trackerSections.insertBefore(draggedSectionElement, targetSection.nextSibling);
            }
        };

        const handleSectionDragEnd = (e) => {
            const section = getLayoutSectionElement(e.target);
            if (section) {
                section.classList.remove('dragging-section');
            }
            if (isLayoutEditMode) {
                syncTrackerLayoutOrder();
            }
            draggedSectionElement = null;
        };

        const handleSectionDrop = (e) => {
            if (!isLayoutEditMode) return;
            e.preventDefault();
            if (!draggedSectionElement) return;
            syncTrackerLayoutOrder();
            showNotification("íŠ¸ë˜ì»¤ ì„¹ì…˜ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
        };
        // --- End Layout Section Drag and Drop Handlers ---


        // --- Hold-to-Repeat Event Setup ---
        const setupCounterEvents = (button, charId, fieldName, action) => {
            const startRepeat = (e) => {
                if (e.type === 'mousedown' && e.button !== 0) return;
                if (e.type === 'touchstart') e.preventDefault();

                stopRepeat();

                // 1. Execute the action immediately on press/touch start
                handleCountAction(charId, fieldName, action);

                // 2. Set timeout for the initial delay before repetition starts
                repeatTimeout = setTimeout(() => {
                    // 3. Start the repeating interval after the initial delay
                    repeatTimer = setInterval(() => {
                        handleCountAction(charId, fieldName, action);
                    }, REPEAT_RATE);
                }, INITIAL_DELAY);
            };

            const stopAction = () => {
                stopRepeat();
            };

            // Start: mouse down or touch start
            button.addEventListener('mousedown', startRepeat);
            button.addEventListener('touchstart', startRepeat);

            // Stop: mouse up, mouse leave (for desktop), touch end, touch cancel
            button.addEventListener('mouseup', stopAction);
            button.addEventListener('mouseleave', stopAction);
            button.addEventListener('touchend', stopAction);
            button.addEventListener('touchcancel', stopAction);
        };

        // --- Event Handlers ---
        window.onload = () => {
            loadTheme();
            loadMotionPreference();
            loadFromLocalStorage();
            applyTrackerLayout();
            setLayoutEditMode(false);

            // Set initial view and button handler
            window.switchView('tracker');

            // Add global drag/drop handlers to the list container
            const characterListDiv = document.getElementById('character-list');
            characterListDiv.addEventListener('dragover', handleDragOver);
            characterListDiv.addEventListener('drop', handleDrop);

            const trackerSections = document.getElementById('tracker-sections');
            if (trackerSections) {
                trackerSections.addEventListener('dragover', handleSectionDragOver);
                trackerSections.addEventListener('drop', handleSectionDrop);
            }
            document.querySelectorAll('.layout-section').forEach((section) => {
                section.addEventListener('dragstart', handleSectionDragStart);
                section.addEventListener('dragend', handleSectionDragEnd);
            });

            // ë©”ëª¨ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const memoInput = document.getElementById('memo-input');
            if (memoInput) {
                memoInput.addEventListener('input', () => {
                    localStorage.setItem(MEMO_KEY, memoInput.value);
                });
            }

            const charForm = document.getElementById('add-char-form');
            charForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('char-name-input');
                const name = nameInput.value.trim();

                if (name) {
                    addCharacter(name);
                    nameInput.value = ''; // Clear input
                    showNotification(`'${name}' ìºë¦­í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    showNotification("ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            });

            // ì „ì²´/ì£¼ê°„/ì›”ê°„ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const resetAllButton = document.getElementById('reset-all-button');
            if (resetAllButton) {
                resetAllButton.addEventListener('click', resetAllData);
            }
            const resetWeeklyButton = document.getElementById('reset-weekly-button');
            if (resetWeeklyButton) {
                resetWeeklyButton.addEventListener('click', resetWeeklyData);
            }
            const resetMonthlyButton = document.getElementById('reset-monthly-button');
            if (resetMonthlyButton) {
                resetMonthlyButton.addEventListener('click', resetMonthlyData);
            }
        };

        // --- Custom Notification/Modal (Replacing alert/confirm) ---
        const showNotification = (message, type = 'info') => {
            const notification = document.getElementById('notification-box');
            notification.textContent = message;

            // Color based on type
            notification.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transition-all duration-300 transform translate-y-full opacity-0 z-50`;
            if (type === 'success') {
                notification.classList.add('bg-green-600');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600');
            } else {
                notification.classList.add('bg-gray-800');
            }

            // Show notification
            setTimeout(() => {
                notification.classList.remove('translate-y-full', 'opacity-0');
                notification.classList.add('translate-y-0', 'opacity-100');
            }, 50);

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('translate-y-0', 'opacity-100');
                notification.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        };

        // Custom window.confirm implementation (simple modal)
        window.confirm = (message) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmation-modal');
                const modalMessage = document.getElementById('modal-message');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                modalMessage.textContent = message;
                modal.classList.remove('hidden');

                const cleanUp = () => {
                    modal.classList.add('hidden');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                };

                confirmBtn.onclick = () => {
                    cleanUp();
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    cleanUp();
                    resolve(false);
                };
            });
        };

    </script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Dark Theme Defaults */
            --bg-page: #111827; /* gray-900 equivalent */
            --bg-primary: #1e293b; /* slate-800 */
            --bg-secondary: #334155; /* slate-700 */
            --color-text: #ffffff;
            --color-text-subtle: #9ca3af; /* gray-400 */
            --color-border: #374151; /* gray-700 */
            --color-accent: #3b82f6; /* accent-blue */
            --color-reset: #ef4444; /* accent-red */
            /* NEW: Pin Highlight Color */
            --color-pin-highlight: #facc15; /* yellow-400 for dark mode */
            --color-pin-shadow: 247, 243, 195; /* R G B for yellow-100/200 effect */
            --goal-accent-rgb: 250, 204, 21;
            --goal-badge-text: #111827;
            --goal-badge-grad-1: #fde68a;
            --goal-badge-grad-2: #f59e0b;
            --goal-badge-grad-3: #fcd34d;
            --coin-color: #facc15;
            --coin-rgb: 250, 204, 21;
        }

        .light-theme {
            /* Light Theme Overrides */
            --bg-page: #f3f4f6; /* gray-100 */
            --bg-primary: #ffffff; /* white */
            --bg-secondary: #e5e7eb; /* gray-200 */
            --color-text: #1f2937; /* gray-900 */
            --color-text-subtle: #6b7280; /* gray-500 */
            --color-border: #d1d5db; /* gray-300 */
            --color-accent: #1d4ed8; /* blue-700 */
            --color-reset: #b91c1c; /* red-700 */
            /* NEW: Pin Highlight Color for light mode (dark gray) */
            --color-pin-highlight: #1f2937; /* gray-800 for light mode */
            --color-pin-shadow: 31, 41, 55; /* R G B for gray-800/900 effect */
        }

        /* Apply CSS variables to common elements */
        body {
            background-color: var(--bg-page);
            color: var(--color-text);
        }

        .bg-primary-theme { background-color: var(--bg-primary); }
        .bg-secondary-theme { background-color: var(--bg-secondary); }
        .text-subtle-theme { color: var(--color-text-subtle); }
        .border-theme { border-color: var(--color-border); }

        /* Theme overrides for hardcoded Tailwind classes using CSS variables */
        .text-accent-blue { color: var(--color-accent); }
        .bg-accent-blue { background-color: var(--color-accent); }
        .hover\:bg-blue-600:hover { background-color: var(--color-accent); opacity: 0.8; }

        .text-accent-red { color: var(--color-reset); }
        .bg-accent-red { background-color: var(--color-reset); }
        .hover\:bg-red-600:hover { background-color: var(--color-reset); opacity: 0.8; }

        .reset-quick-btn {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-secondary);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            font-size: 19px;
            line-height: 1;
            box-shadow: 0 6px 14px -10px rgba(0, 0, 0, 0.7);
            transition: transform 0.15s ease, opacity 0.2s ease, border-color 0.2s ease;
        }
        .reset-quick-btn:hover {
            opacity: 0.88;
            transform: translateY(-1px);
            border-color: var(--color-accent);
        }
        .reset-quick-btn:active {
            transform: translateY(0);
        }
        .reset-quick-btn-danger {
            background-color: var(--color-reset);
            border-color: transparent;
            color: #fff;
        }
        .reset-quick-btn-danger:hover {
            border-color: transparent;
        }

        /* Input and Textarea styling */
        .theme-input {
            background-color: var(--bg-primary);
            border-width: 1px;
            border-color: var(--color-border);
            color: var(--color-text);
        }
        .theme-input::placeholder { color: var(--color-text-subtle); }

        /* Custom scrollbar for theme */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: var(--bg-page); }
        body::-webkit-scrollbar-thumb { background: var(--bg-secondary); border-radius: 4px; }
        body::-webkit-scrollbar-thumb:hover { background: var(--color-text-subtle); }

        body[data-motion="off"] *,
        body[data-motion="off"] *::before,
        body[data-motion="off"] *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        /* Drag and Drop Visuals */
        .drag-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }
        .dragging-section {
            opacity: 0.65;
            box-shadow: 0 12px 22px -8px rgba(0, 0, 0, 0.4);
        }
        .layout-edit-mode .layout-section {
            border: 1px dashed var(--color-accent);
            border-radius: 0.9rem;
            cursor: grab;
            position: relative;
        }
        .layout-edit-mode .layout-section::before {
            content: "Drag section";
            position: absolute;
            top: -10px;
            right: 12px;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: var(--color-accent);
            color: #fff;
            letter-spacing: 0.02em;
        }
        .layout-edit-mode .layout-section:active {
            cursor: grabbing;
        }
        .layout-edit-mode .layout-section[data-section-id="character-list"] {
            max-height: 58vh;
            overflow: hidden;
        }
        .layout-edit-mode .layout-section[data-section-id="character-list"] #character-list {
            max-height: calc(58vh - 72px);
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Goal Completion Celebration */
        .goal-achieved-card {
            position: relative;
            overflow: hidden;
            isolation: isolate;
            border-color: rgba(var(--goal-accent-rgb), 0.8);
            box-shadow: 0 0 0 1px rgba(var(--goal-accent-rgb), 0.25), 0 18px 35px -24px rgba(var(--goal-accent-rgb), 0.85);
        }
        .goal-achieved-card::before {
            content: "";
            position: absolute;
            inset: -30%;
            background: conic-gradient(
                from 90deg,
                rgba(var(--goal-accent-rgb), 0),
                rgba(var(--goal-accent-rgb), 0.32),
                rgba(255, 255, 255, 0),
                rgba(var(--goal-accent-rgb), 0.25),
                rgba(var(--goal-accent-rgb), 0)
            );
            z-index: 0;
            pointer-events: none;
        }

        .goal-achieved-card > * {
            position: relative;
            z-index: 2;
        }
        .goal-counter {
            text-shadow: 0 0 14px rgba(var(--goal-accent-rgb), 0.7);
        }
        body[data-theme="light"] .goal-counter {
            color: #1d4ed8 !important;
            text-shadow: 0 0 10px rgba(29, 78, 216, 0.35);
        }
        .counter-section {
            position: relative;
            overflow: visible;
        }
        .goal-celebration {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }
        .goal-celebration .goal-badge {
            position: absolute;
            top: 10px;
            right: 12px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.02em;
            color: var(--goal-badge-text);
            background: linear-gradient(90deg, var(--goal-badge-grad-1), var(--goal-badge-grad-2), var(--goal-badge-grad-3));
            box-shadow: 0 8px 18px -10px rgba(var(--goal-accent-rgb), 0.9);
        }
        .fx-money-coin {
            position: absolute;
            left: 50%;
            bottom: calc(12px + var(--row-y, 0px));
            font-size: 18px;
            font-weight: 700;
            color: var(--coin-color);
            text-shadow: 0 0 9px rgba(var(--coin-rgb), 0.7);
            transform: translateX(var(--offset-x));
            opacity: 0;
            animation: money-burst 1.7s ease-out infinite;
            animation-delay: var(--delay);
        }
        @keyframes money-burst {
            0% { opacity: 0; transform: translateX(var(--offset-x)) translateY(0) scale(0.62); }
            16% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; transform: translateX(var(--offset-x)) translateY(-58px) rotate(12deg) scale(1.1); }
        }
        @media (prefers-reduced-motion: reduce) {
            .goal-celebration .goal-badge,
            .fx-money-coin {
                animation: none !important;
            }
        }
        /* Pinned Item Highlighting using CSS Variables */
        .text-pin-highlight {
            color: var(--color-pin-highlight);
        }
        .border-pin-highlight {
            border-color: var(--color-pin-highlight);
            box-shadow: 0 4px 6px -1px rgba(var(--color-pin-shadow), 0.1), 0 2px 4px -2px rgba(var(--color-pin-shadow), 0.06);
        }

    </style>
</head>
<body class="min-h-screen font-sans p-4 sm:p-8">

    <!-- Confirmation Modal Structure -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-secondary-theme p-6 rounded-xl shadow-2xl max-w-sm w-full border border-theme">
            <p id="modal-message" class="text-lg font-semibold mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition shadow-md">ì·¨ì†Œ</button>
                <button id="modal-confirm" class="px-4 py-2 bg-accent-red text-white rounded-lg hover:bg-red-600 transition shadow-md">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Notification Box -->
    <div id="notification-box" class="fixed bottom-4 right-4 p-3 rounded-lg shadow-xl text-white transition-all duration-300 transform translate-y-full opacity-0 z-50">
        <!-- Notification message will be inserted here -->
    </div>

    <div id="app-container" class="max-w-4xl mx-auto">

        <!-- Header with Theme Toggle and View Toggle -->
        <header class="text-center mb-8 flex flex-col sm:flex-row justify-center sm:justify-between items-center relative">

            <!-- View Toggle Button (NEW) -->
            <button id="view-toggle-button" onclick="switchView('settlement')"
                    class="order-2 sm:order-1 mt-4 sm:mt-0 px-4 py-2 bg-accent-blue text-white font-semibold rounded-lg hover:opacity-80 transition shadow-lg w-full sm:w-auto text-sm">
                ğŸ’° ì •ì‚°í‘œ ë³´ê¸°
            </button>

            <div class="text-center order-1 sm:order-2">
                <h1 class="text-4xl font-extrabold text-accent-blue mb-2">ëƒ¥ê³¨ ë˜ì „ ìˆ™ì œ íŠ¸ë˜ì»¤</h1>
                <p class="text-subtle-theme">ìºë¦­í„°ë³„ ì£¼ê°„/ì›”ê°„ í´ë¦¬ì–´ íšŸìˆ˜ ë° ë³´ìƒ ì •ì‚°</p>
            </div>

            <!-- Theme Toggle Button -->
            <button id="theme-toggle" onclick="toggleTheme()" class="order-3 absolute top-0 right-0 sm:static p-2 rounded-full bg-secondary-theme hover:opacity-80 transition shadow-lg text-2xl" title="í…Œë§ˆ ì „í™˜">
                <span id="theme-icon">ğŸŒ™</span>
            </button>
        </header>
        <div class="mb-4 flex justify-end gap-2">
            <button id="motion-toggle" onclick="toggleMotionEffects()"
                    class="px-4 py-2 bg-primary-theme border border-theme rounded-lg text-sm font-semibold hover:opacity-80 transition">
                Animation ON
            </button>
            <button id="layout-edit-toggle" onclick="toggleLayoutEditMode()"
                    class="px-4 py-2 bg-primary-theme border border-theme rounded-lg text-sm font-semibold hover:opacity-80 transition">
                ë ˆì´ì•„ì›ƒ í¸ì§‘
            </button>
        </div>

        <!-- User Info & Disclaimer -->
        <div class="mb-6 bg-primary-theme p-4 rounded-xl shadow border border-theme">
            <p id="user-info" class="text-sm text-subtle-theme">ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>
            <p class="text-xs text-blue-500 mt-1">â€» ë°ì´í„°ëŠ” í˜„ì¬ ë¸Œë¼ìš°ì €ì˜ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë˜ë¯€ë¡œ, ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- --- TRACKER VIEW CONTENT --- -->
        <div id="tracker-view">
            <div id="tracker-sections" class="space-y-8">
            <!-- Memo Section (Collapsible) -->
            <details class="layout-section mb-8 p-6 bg-secondary-theme rounded-xl shadow-lg border border-theme" data-section-id="memo">
                <summary class="text-2xl font-bold cursor-pointer select-none">
                    ğŸ“ ë©”ëª¨/ììœ  ê¸°ë¡ (ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ì—´ê³  ë‹«ê¸°)
                </summary>
                <textarea id="memo-input"
                            class="theme-input w-full h-32 mt-4 p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue outline-none"
                            placeholder="ì—¬ê¸°ì— ììœ ë¡­ê²Œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.)"
                ></textarea>
            </details>

            <!-- Add Character Form -->
            <div class="layout-section mb-8 p-6 bg-secondary-theme rounded-xl shadow-lg border border-theme" data-section-id="add-character">
                <h2 class="text-2xl font-bold mb-4">ìƒˆ ìºë¦­í„° ì¶”ê°€</h2>
                <form id="add-char-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <input
                        type="text"
                        id="char-name-input"
                        placeholder="ìºë¦­í„° ì´ë¦„ (ì˜ˆ: ì‚¬ëƒ)"
                        required
                        class="theme-input flex-grow p-3 border rounded-lg focus:ring-accent-blue focus:border-accent-blue outline-none"
                    >
                    <button type="submit" class="w-full sm:w-auto px-6 py-3 bg-accent-blue text-white font-semibold rounded-lg hover:bg-blue-600 transition shadow-lg">
                        ìºë¦­í„° ì¶”ê°€
                    </button>
                </form>
            </div>

            <!-- Count Reset Section (Compact) -->
            <div class="layout-section mb-8 p-3 sm:p-4 bg-primary-theme rounded-xl shadow-lg border border-theme flex flex-col sm:flex-row items-center justify-between gap-3" data-section-id="reset">
                <span class="text-sm font-semibold text-subtle-theme">ì „ì²´ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”</span>
                <div class="flex items-center gap-2">
                    <button id="reset-weekly-button" class="reset-quick-btn" title="ì£¼ê°„ ì „ì²´ ì´ˆê¸°í™”" aria-label="ì£¼ê°„ ì „ì²´ ì´ˆê¸°í™”">
                        <span aria-hidden="true">&#8635;</span>
                    </button>
                    <button id="reset-monthly-button" class="reset-quick-btn" title="ì›”ê°„ ì „ì²´ ì´ˆê¸°í™”" aria-label="ì›”ê°„ ì „ì²´ ì´ˆê¸°í™”">
                        <span aria-hidden="true">&#128197;</span>
                    </button>
                    <button id="reset-all-button" class="reset-quick-btn reset-quick-btn-danger" title="ì£¼ê°„/ì›”ê°„ ì „ì²´ ì´ˆê¸°í™”" aria-label="ì£¼ê°„/ì›”ê°„ ì „ì²´ ì´ˆê¸°í™”">
                        <span aria-hidden="true">&#128472;</span>
                    </button>
                </div>
            </div>

            <!-- Character List -->
            <section class="layout-section" data-section-id="character-list">
                <h2 class="text-2xl font-bold mb-4 border-b border-theme pb-2">ìºë¦­í„° í˜„í™© (ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</h2>
                <div id="character-list" class="space-y-4">
                    <p class="text-subtle-theme p-4 text-center">ìºë¦­í„° ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </section>
            </div>
        </div>

        <!-- --- SETTLEMENT VIEW CONTENT (NEW) --- -->
        <div id="settlement-view" class="hidden">
            <h2 class="text-3xl font-extrabold mb-6 border-b border-theme pb-2 text-blue">ğŸ’° ë³´ìƒ ì •ì‚°í‘œ</h2>
            <div id="settlement-content">
                <!-- Settlement details will be rendered here by renderSettlement() -->
                <p class="text-subtle-theme p-4 text-center">ì •ì‚°í‘œ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

    </div>

</body>
</html>
